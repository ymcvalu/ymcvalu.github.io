<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="gopher">
    <meta name="keyword" content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        gopark - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<meta name="google-site-verification" content="fDu2EbXziVRK-QATAvl0GYkq0mLojeEfo2tAFJVbtek" />

<body>

    <div class="site-nav-toggle" id="site-nav-toggle">
        <button>
            <span class="btn-bar"></span>
            <span class="btn-bar"></span>
            <span class="btn-bar"></span>
        </button>
    </div>

    <div class="index-about">
        <i>  </i>
    </div>

    <div class="index-container">
        
        <div class="index-left">
            
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/img/avatar.jpg">
        </div>
        <div class="name">
            <i>can</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>å­˜æ¡£</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>å…³äº</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>æœç´¢</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#å®ç°"><span class="toc-text">å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä½¿ç”¨"><span class="toc-text">ä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#åœºæ™¯ä¸€ï¼šå†™ç©º-channel"><span class="toc-text">åœºæ™¯ä¸€ï¼šå†™ç©º channel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#åœºæ™¯äºŒï¼šselect"><span class="toc-text">åœºæ™¯äºŒï¼šselect</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">æœç´¢</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
            <div class="index-about-mobile">
                <i>  </i>
            </div>
        </div>
        
        <div class="index-middle">
            <!-- Main Content -->
            


<div class="post-container">
    <div class="post-title">
        gopark
    </div>

    <div class="post-meta">
        <span class="attr">å‘å¸ƒäºï¼š<span>2019-08-26 22:16:53</span></span>
        
        <span class="attr">æ ‡ç­¾ï¼š/
        
        <a class="tag" href="/tags/#go - runtime" title="go - runtime">go - runtime</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">è®¿é—®ï¼š<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content ">
        <p> åœ¨ go çš„ runtime åŒ…ä¸­ï¼Œç»å¸¸èƒ½å¤Ÿçœ‹åˆ°<code>gopark</code>æ–¹æ³•ï¼Œä»Šå¤©æ¥çœ‹ä¸€ä¸‹è¯¥å‡½æ•°çš„å®ç°å’Œä½œç”¨ã€‚</p>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><p>è¯¥æ–¹æ³•çš„æºç åœ¨<code>runtime/proc.go</code>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Puts the current goroutine into a waiting state and calls unlockf.</span></span><br><span class="line"><span class="comment">// If unlockf returns false, the goroutine is resumed.</span></span><br><span class="line"><span class="comment">// unlockf must not access this G's stack, as it may be moved between</span></span><br><span class="line"><span class="comment">// the call to gopark and the call to unlockf.</span></span><br><span class="line"><span class="comment">// Reason explains why the goroutine has been parked.</span></span><br><span class="line"><span class="comment">// It is displayed in stack traces and heap dumps.</span></span><br><span class="line"><span class="comment">// Reasons should be unique and descriptive.</span></span><br><span class="line"><span class="comment">// Do not re-use reasons, add new ones.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®ä¸Šé¢çš„æ³¨é‡Šï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯å¦‚æœunlockfè¿”å›trueï¼Œåˆ™å°†å½“å‰åç¨‹æŒ‚èµ·ï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">gopark</span><span class="params">(unlockf <span class="keyword">func</span>(*g, unsafe.Pointer)</span> <span class="title">bool</span>, <span class="title">lock</span> <span class="title">unsafe</span>.<span class="title">Pointer</span>, <span class="title">reason</span> <span class="title">waitReason</span>, <span class="title">traceEv</span> <span class="title">byte</span>, <span class="title">traceskip</span> <span class="title">int</span>)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> reason != waitReasonSleep &#123;</span><br><span class="line">		checkTimeouts() <span class="comment">// timeouts may expire while two goroutines keep the scheduler busy</span></span><br><span class="line">	&#125;</span><br><span class="line">	mp := acquirem() <span class="comment">// è¿™é‡Œè·å–å½“å‰çš„må¹¶åŠ é”</span></span><br><span class="line">	gp := mp.curg <span class="comment">// gpå³ä¸ºå½“å‰è¿è¡Œçš„åç¨‹</span></span><br><span class="line">	status := readgstatus(gp)</span><br><span class="line">    <span class="comment">// æ£€æŸ¥gpçš„çŠ¶æ€</span></span><br><span class="line">	<span class="keyword">if</span> status != _Grunning &amp;&amp; status != _Gscanrunning &#123;</span><br><span class="line">		throw(<span class="string">"gopark: bad g status"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// å°† lock å’Œ unlockf åˆ†åˆ«ä¿å­˜åˆ° mp çš„ waitlock å’Œ waitunlockf</span></span><br><span class="line">    <span class="comment">// unlockf éœ€è¦æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ gpï¼Œå¦ä¸€ä¸ªå°±æ˜¯å‚æ•° lock</span></span><br><span class="line">	mp.waitlock = lock</span><br><span class="line">	mp.waitunlockf = *(*unsafe.Pointer)(unsafe.Pointer(&amp;unlockf))</span><br><span class="line">    <span class="comment">// ç­‰å¾…çš„åŸå› </span></span><br><span class="line">	gp.waitreason = reason</span><br><span class="line">    <span class="comment">// traceç›¸å…³</span></span><br><span class="line">	mp.waittraceev = traceEv</span><br><span class="line">	mp.waittraceskip = traceskip</span><br><span class="line">	releasem(mp) <span class="comment">// é‡Šæ”¾å½“å‰m</span></span><br><span class="line">	<span class="comment">// can't do anything that might move the G between Ms here.</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œmcallæ˜¯ä¸€ä¸ªç”±æ±‡ç¼–å®ç°çš„å‡½æ•°ï¼Œæ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œç„¶ååˆ‡æ¢åˆ° m çš„ g0 æ ˆå»æ‰§è¡Œè¿™ä¸ªå‡½æ•°</span></span><br><span class="line">	mcall(park_m) <span class="comment">// åˆ‡æ¢åˆ° m çš„ g0 æ ˆæ‰§è¡Œ park_m æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦å…ˆæ¥çœ‹ä¸€ä¸‹ <code>park_m</code> è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼Œè¯¥æ–¹æ³•åŒæ ·ä½äº<code>runtime/proc.go</code>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// park continuation on g0.</span></span><br><span class="line"><span class="comment">// mcall æ–¹æ³•ä¼šåˆ‡æ¢åˆ° m çš„ g0 è¿è¡Œï¼Œç„¶åæŠŠåŸå…ˆçš„ g ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¯¥æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">park_m</span><span class="params">(gp *g)</span></span> &#123;</span><br><span class="line">	_g_ := getg() <span class="comment">// è·å–å½“å‰è¿è¡Œçš„ gï¼Œè¿™æ—¶å€™è¿”å›çš„æ˜¯ g0</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">// å¦‚æœå¼€å¯äº†traceï¼Œåˆ™å‘é€traceäº‹ä»¶</span></span><br><span class="line">	<span class="keyword">if</span> trace.enabled &#123;</span><br><span class="line">		traceGoPark(_g_.m.waittraceev, _g_.m.waittraceskip)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// casæ›´æ–°gpçš„çŠ¶æ€</span></span><br><span class="line">	casgstatus(gp, _Grunning, _Gwaiting)</span><br><span class="line">    <span class="comment">// è¿™é‡Œå°† gp ä¸ m åˆ†ç¦»</span></span><br><span class="line">	dropg()</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// è¿™é‡Œçš„ waitunlockf å°±æ˜¯ä¸Šé¢ gopark æ–¹æ³•çš„å‚æ•° unlockf</span></span><br><span class="line">    <span class="comment">// åœ¨ gopark ä¸­åˆ†åˆ«å°†å…¶ä¸¤ä¸ªå‚æ•° unlockf å’Œ lock ä¿å­˜åˆ° m çš„ waitunlockf å’Œ waitlockå­—æ®µä¸­</span></span><br><span class="line">	<span class="keyword">if</span> _g_.m.waitunlockf != <span class="literal">nil</span> &#123; <span class="comment">// å¦‚æœ gopark æ–¹æ³•æ¥æ”¶çš„ unlockf ä¸ä¸ºç©º</span></span><br><span class="line">		fn := *(*<span class="function"><span class="keyword">func</span><span class="params">(*g, unsafe.Pointer)</span> <span class="title">bool</span>)<span class="params">(unsafe.Pointer(&amp;_g_.m.waitunlockf)</span>)</span></span><br><span class="line"><span class="function">		// <span class="title">waitlock</span> å°±æ˜¯ <span class="title">gopark</span> æ–¹æ³•çš„å¦ä¸€ä¸ªå‚æ•° <span class="title">lock</span></span></span><br><span class="line"><span class="function">        <span class="title">ok</span> := <span class="title">fn</span><span class="params">(gp, _g_.m.waitlock)</span></span></span><br><span class="line"><span class="function">        // åŠæ—¶æ¸…ç©º <span class="title">m</span> çš„ä¸¤ä¸ªè¿™ä¸¤ä¸ªå­—æ®µ</span></span><br><span class="line"><span class="function">		_<span class="title">g_</span>.<span class="title">m</span>.<span class="title">waitunlockf</span> = <span class="title">nil</span> </span></span><br><span class="line"><span class="function">		_<span class="title">g_</span>.<span class="title">m</span>.<span class="title">waitlock</span> = <span class="title">nil</span></span></span><br><span class="line"><span class="function">        // å¦‚æœ <span class="title">unlockf</span> è¿”å›äº† <span class="title">false</span>ï¼Œé‚£ä¹ˆä¸è¦æŒ‚èµ·ï¼Œç»§ç»­æ‰§è¡Œ</span></span><br><span class="line"><span class="function">		<span class="title">if</span> !<span class="title">ok</span></span> &#123;</span><br><span class="line">			<span class="keyword">if</span> trace.enabled &#123;</span><br><span class="line">				traceGoUnpark(gp, <span class="number">2</span>)</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">// çŠ¶æ€åˆ‡æ¢ä¸º _Grunnable</span></span><br><span class="line">			casgstatus(gp, _Gwaiting, _Grunnable)</span><br><span class="line">            <span class="comment">// é‡æ–°ç»‘å®š gp åˆ°å½“å‰ mï¼Œå¹¶æ¢å¤æ‰§è¡Œï¼Œè¯¥æ–¹æ³•ä¸ä¼šè¿”å›</span></span><br><span class="line">			execute(gp, <span class="literal">true</span>) <span class="comment">// Schedule it back, never returns.</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// unlockf ä¸º nil æˆ–è€…è¿”å› trueï¼Œåˆ™æŒ‚èµ· gpï¼Œå¹¶é‡æ–°è°ƒåº¦æ–°çš„ g åˆ°å½“å‰ m</span></span><br><span class="line">	schedule() <span class="comment">// åç¨‹è°ƒåº¦ï¼Œè¯¥æ–¹æ³•ä¹Ÿä¸ä¼šè¿”å›</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®ä¸Šé¢çš„ <code>park_m</code>çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ <code>mcall</code> æ–¹æ³•éœ€è¦ä¿å­˜ <code>gp</code> çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¹¶åˆ‡æ¢åˆ° <code>g0</code> æ ˆï¼Œä»¥ <code>gp</code> ä½œä¸ºå‚æ•°è°ƒç”¨ <code>park_m</code>ã€‚</p>
<p>åœ¨çœ‹ <code>mcall</code> æ–¹æ³•çš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ <code>g</code> ä¸­çš„ å‡ ä¸ªå­—æ®µï¼Œ<code>g</code>çš„å®ç°åœ¨<code>runtime/runtime2.go</code>ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> g <span class="keyword">struct</span> &#123;</span><br><span class="line">	stack       stack   <span class="comment">// å½“å‰gçš„æ ˆä¿¡æ¯</span></span><br><span class="line"> 	...</span><br><span class="line">	m              *m      <span class="comment">// å½“å‰gç»‘å®šçš„m</span></span><br><span class="line">	sched          gobuf   <span class="comment">// ä¿å­˜gçš„è¿è¡Œä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¸‹æ¬¡è°ƒåº¦æ—¶ä»å“ªé‡Œå¼€å§‹æ‰§è¡Œ</span></span><br><span class="line">	... </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> stack <span class="keyword">struct</span> &#123;</span><br><span class="line">	lo <span class="keyword">uintptr</span> <span class="comment">// æ ˆåº•</span></span><br><span class="line">	hi <span class="keyword">uintptr</span> <span class="comment">// æ ˆé¡¶</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> gobuf <span class="keyword">struct</span> &#123;</span><br><span class="line">	sp   <span class="keyword">uintptr</span> 	 <span class="comment">// æ ˆé¡¶</span></span><br><span class="line">	pc   <span class="keyword">uintptr</span>	 <span class="comment">// pcï¼Œæ¢å¤ç‚¹</span></span><br><span class="line">	g    guintptr    <span class="comment">// å¯¹åº”çš„gæŒ‡é’ˆå€¼</span></span><br><span class="line">	ctxt unsafe.Pointer</span><br><span class="line">	ret  sys.Uintreg</span><br><span class="line">	lr   <span class="keyword">uintptr</span></span><br><span class="line">	bp   <span class="keyword">uintptr</span>     <span class="comment">// æ ˆåº•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ <code>mcall</code> åœ¨ <code>amd64</code> ä½“ç³»ä¸‹çš„å®ç°ï¼Œæºä»£ç ä½äº <code>runtime/asm_amd64.s</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">// func mcall(fn func(*g))</span><br><span class="line">// Switch to m-&gt;g0&apos;s stack, call fn(g).</span><br><span class="line">// Fn must never return. It should gogo(&amp;g-&gt;sched)</span><br><span class="line">// to keep running g.</span><br><span class="line">// </span><br><span class="line">// æ ¹æ®æ³¨é‡Šï¼Œmcall åˆ‡æ¢åˆ° g0 æ ˆè°ƒç”¨ fn(g), fn ä¸èƒ½è¿”å›</span><br><span class="line">TEXT runtimeÂ·mcall(SB), NOSPLIT, $0-8 // æ ˆå¸§å¤§å°ä¸º0ï¼Œè¿™ç§æƒ…å†µ0(SP)ä¿å­˜çš„ä¸ºè¿”å›åœ°å€</span><br><span class="line">	// å…³äºgoçš„å‡½æ•°è°ƒç”¨æ ˆçš„å¸ƒå±€ï¼Œå¯ä»¥å‚è€ƒ http://mcll.top/2019/04/29/goå‡½æ•°æ ˆå¸ƒå±€</span><br><span class="line">	</span><br><span class="line">	MOVQ	fn+0(FP), DI // å°†mcallçš„å‚æ•°ä¿å­˜åˆ°DIå¯„å­˜å™¨ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªfuncvalæŒ‡é’ˆ</span><br><span class="line">	// å…³äºfuncvalçš„ä»‹ç»ï¼Œå¯ä»¥å‚è€ƒhttp://mcll.top/2019/03/06/goä¸­çš„çŒ´å­è¡¥ä¸</span><br><span class="line"></span><br><span class="line">	get_tls(CX)  // å°†TLSä¿å­˜åˆ°CXå¯„å­˜å™¨ï¼ŒTLSæ˜¯ä¸€ä¸ªä¼ªå¯„å­˜å™¨ï¼Œget_tlsæ˜¯ä¸€ä¸ªå®ï¼Œä¸€ç›´æ²¡æ‰¾åˆ°å…¶å®šä¹‰ğŸ˜“</span><br><span class="line">	MOVQ	g(CX), AX	// ä¿å­˜å½“å‰gåˆ°AXå¯„å­˜å™¨ä¸­</span><br><span class="line">	MOVQ	0(SP), BX	// 0(SP)ä¿å­˜è¿”å›åœ°å€ï¼Œä¹Ÿå°±æ˜¯mcallè°ƒç”¨è€…çš„PC</span><br><span class="line">	MOVQ	BX, (g_sched+gobuf_pc)(AX) // ä¿å­˜åˆ°g.sched.pcå­—æ®µä¸­</span><br><span class="line">	LEAQ	fn+0(FP), BX	// fn+0(FP)ä¹Ÿå°±æ˜¯è°ƒç”¨è€…çš„SP</span><br><span class="line">	MOVQ	BX, (g_sched+gobuf_sp)(AX) // ä¿å­˜åˆ°g.sched.spå­—æ®µä¸­</span><br><span class="line">	MOVQ	AX, (g_sched+gobuf_g)(AX) // ä¿å­˜å½“å‰gåˆ°g.sched.gä¸­</span><br><span class="line">	MOVQ	BP, (g_sched+gobuf_bp)(AX) // å› ä¸ºæ ˆå¸§ä¸º0ï¼ŒBPå°±æ˜¯è°ƒç”¨è€…çš„BPï¼Œä¿å­˜åˆ°g.sched.bp</span><br><span class="line"></span><br><span class="line">	// switch to m-&gt;g0 &amp; its stack, call fn</span><br><span class="line">	MOVQ	g(CX), BX  // å°†åŸæ¥çš„gä¿å­˜åˆ°BX</span><br><span class="line">	MOVQ	g_m(BX), BX  // è·å–g.mï¼Œè¿˜æ˜¯ä¿å­˜åˆ°BX</span><br><span class="line">	MOVQ	m_g0(BX), SI // ä¿å­˜g0åˆ°SI</span><br><span class="line">	CMPQ	SI, AX	// AXå¯„å­˜å™¨ä¸Šé¢å·²ç»è®¾ç½®ä¸ºåŸæ¥çš„gäº†ï¼Œç¦æ­¢åœ¨g0æ ˆä¸Šè°ƒç”¨mcallï¼Œè¿™é‡Œè¦åˆ¤æ–­ä¸€ä¸‹</span><br><span class="line">	JNE	3(PC) // å¦‚æœåŸæ¥çš„gä¸æ˜¯g0ï¼Œè·³è½¬åˆ°pc+3çš„ä½ç½®æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ä»è¿™é‡Œå¾€ä¸‹ç¬¬ä¸‰æ¡æŒ‡ä»¤</span><br><span class="line">	MOVQ	$runtimeÂ·badmcall(SB), AX // å¦‚æœåœ¨g0ä¸Šè°ƒç”¨mcallï¼Œç›´æ¥panic</span><br><span class="line">	JMP	AX // è·³è½¬åˆ° badmcall æ–¹æ³•ï¼Œæœ€ç»ˆä¼španic</span><br><span class="line">	MOVQ	SI, g(CX)	// å°†g0è®¾ç½®åˆ°TLSä¸­</span><br><span class="line">	MOVQ	(g_sched+gobuf_sp)(SI), SP	// æ¢å¤g0çš„SPå¯„å­˜å™¨</span><br><span class="line">	PUSHQ	AX	// AXä¿å­˜åŸæ¥çš„gï¼Œå…¥æ ˆ</span><br><span class="line">	MOVQ	DI, DX // ä¸Šé¢è¯´è¿‡ï¼ŒDIä¿å­˜äº†è¦è°ƒç”¨å‡½æ•°çš„funcvalå€¼ï¼Œå°†å…¶ä¿å­˜çš„DXå¯„å­˜å™¨ï¼ŒDXå¯„å­˜å™¨ä¸é—­åŒ…å®ç°æœ‰å…³</span><br><span class="line">	MOVQ	0(DI), DI // å°†è¦è°ƒç”¨å‡½æ•°çš„å…¥å£åœ°å€ä¿å­˜åˆ°DIå¯„å­˜å™¨</span><br><span class="line">	CALL	DI // è°ƒç”¨è¯¥å‡½æ•°ï¼Œå‚æ•°å°±æ˜¯åˆšåˆšå…¥æ ˆçš„AXä¸­çš„å€¼ï¼Œä¹Ÿå°±æ˜¯åŸæ¥çš„gï¼Œè¯¥å‡½æ•°ç¦æ­¢è¿”å›</span><br><span class="line">	POPQ	AX // å‡ºæ ˆ</span><br><span class="line">	MOVQ	$runtimeÂ·badmcall2(SB), AX // å¦‚æœè°ƒç”¨å‡½æ•°è¿”å›äº†ï¼Œpanic</span><br><span class="line">	JMP	AX </span><br><span class="line">	RET</span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p><code>runtime</code>åŒ…ä¸­æœ‰å¾ˆå¤šç”¨åˆ°<code>gopark</code>æ–¹æ³•çš„åœ°æ–¹ï¼Œè¿™é‡Œä¸¾ä¾‹å‡ ä¸ª</p>
<h5 id="åœºæ™¯ä¸€ï¼šå†™ç©º-channel"><a href="#åœºæ™¯ä¸€ï¼šå†™ç©º-channel" class="headerlink" title="åœºæ™¯ä¸€ï¼šå†™ç©º channel"></a>åœºæ™¯ä¸€ï¼šå†™ç©º channel</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chansend</span><span class="params">(c *hchan, ep unsafe.Pointer, block <span class="keyword">bool</span>, callerpc <span class="keyword">uintptr</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="comment">// æ ¹æ®goè¯­ä¹‰ï¼Œå‘ä¸€ä¸ªnilçš„channelä¼šå¯¼è‡´é˜»å¡</span></span><br><span class="line">    <span class="keyword">if</span> c == <span class="literal">nil</span> &#123;</span><br><span class="line">     	<span class="comment">// ä¸€èˆ¬blockéƒ½æ˜¯true</span></span><br><span class="line">		<span class="keyword">if</span> !block &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œunlockfä¸ºnilä¼šæŒ‚èµ·å½“å‰åç¨‹</span></span><br><span class="line">		gopark(<span class="literal">nil</span>, <span class="literal">nil</span>, waitReasonChanSendNilChan, traceEvGoStop, <span class="number">2</span>)</span><br><span class="line">		throw(<span class="string">"unreachable"</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="åœºæ™¯äºŒï¼šselect"><a href="#åœºæ™¯äºŒï¼šselect" class="headerlink" title="åœºæ™¯äºŒï¼šselect"></a>åœºæ™¯äºŒï¼šselect</h5><p><code>selectgo</code>å®ç°äº†<code>select</code>è¯­å¥çš„åŠŸèƒ½</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">selectgo</span><span class="params">(cas0 *scase, order0 *<span class="keyword">uint16</span>, ncases <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// selparkcommitä¼šé‡Šæ”¾æ‰€æœ‰caseçš„é”ï¼Œå¹¶é˜»å¡ç­‰å¾…å½“å‰gï¼Œç­‰å¾…æœ‰caseè¢«è§¦å‘</span></span><br><span class="line">    gopark(selparkcommit, <span class="literal">nil</span>, waitReasonSelect, traceEvGoBlockSelect, <span class="number">1</span>)</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
        <div id="comment-container">
        </div>
    </div>
</div>
        </div>
    </div>

    
<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
   <!-- <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p> -->
</footer>




<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":false},"react":{"opacity":0.6}});</script></body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = 
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

</html>