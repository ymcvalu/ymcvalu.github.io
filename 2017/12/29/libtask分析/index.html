<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="fDu2EbXziVRK-QATAvl0GYkq0mLojeEfo2tAFJVbtek">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="gopher">
    <meta name="keyword" content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        libtask分析 - undefined
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

    <div class="site-nav-toggle" id="site-nav-toggle">
        <button>
            <span class="btn-bar"></span>
            <span class="btn-bar"></span>
            <span class="btn-bar"></span>
        </button>
    </div>

    <div class="index-about">
        <i> blog </i>
    </div>

    <div class="index-container">
        
        <div class="index-left">
            
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/img/avatar.jpg">
        </div>
        <div class="name">
            <i>can</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li>
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#Task"><span class="toc-text">Task</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Task创建"><span class="toc-text">Task创建</span></a></li></ol><li class="toc-item toc-level-3"><a class="toc-link" href="#Task调度"><span class="toc-text">Task调度</span></a>
</li></div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
            <div class="index-about-mobile">
                <i> blog </i>
            </div>
        </div>
        
        <div class="index-middle">
            <!-- Main Content -->
            


<div class="post-container">
    <div class="post-title">
        libtask分析
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2017-12-29 23:36:33</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#libtask" title="libtask">libtask</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content ">
        <p><code>libtask</code> 是一个开源的 <code>C</code> 语言协程库。</p>
<p><code>C</code> 语言协程可以通过更改寄存器，切换协程上下文实现协程调度。</p>
<p>更改寄存器可以通过 <code>C</code> 语言内联汇编实现，通过汇编代码直接更改寄存器的内容。</p>
<p>也可以使用 <code>ucontext</code> 配合 <code>getContext</code> 、 <code>setContext</code> 、<code>makeContext</code> 、<code>swapContext</code> 函数来实现。</p>
<p><code>ucontext</code> 结构封装了寄存器信息和栈信息，是协程执行的上下文，而其他四个函数分别用于获取当前执行的上下文，设置当前上下文，创建上下文和交换上下文，这些函数已经封装了对寄存器内容的交换工作。</p>
<h5 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h5><p>一个Task可以看成是一个需要异步执行的任务，coroutine的抽象描述。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Context</span> <span class="title">Context</span>;</span>	</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Context</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">ucontext_t</span>	uc;	<span class="comment">//ucontext封装了协程执行的上下文信息</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Task</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">char</span>	name[<span class="number">256</span>];	<span class="comment">// offset known to acid</span></span><br><span class="line">	<span class="keyword">char</span>	state[<span class="number">256</span>];</span><br><span class="line">	Task	*next;</span><br><span class="line">	Task	*prev;</span><br><span class="line">	Task	*allnext;</span><br><span class="line">	Task	*allprev;</span><br><span class="line">	Context	context;	<span class="comment">//协程上下文</span></span><br><span class="line">	uvlong	alarmtime;</span><br><span class="line">	uint	id;</span><br><span class="line">	uchar	*stk;	<span class="comment">//协程栈指针</span></span><br><span class="line">	uint	stksize;	<span class="comment">//栈大小</span></span><br><span class="line">	<span class="keyword">int</span>	exiting;</span><br><span class="line">	<span class="keyword">int</span>	alltaskslot;	<span class="comment">//在全局task数组内的index</span></span><br><span class="line">	<span class="keyword">int</span>	system;</span><br><span class="line">	<span class="keyword">int</span>	ready;</span><br><span class="line">	<span class="keyword">void</span>	(*startfn)(<span class="keyword">void</span>*);	<span class="comment">//Task需要执行的函数</span></span><br><span class="line">	<span class="keyword">void</span>	*startarg;	<span class="comment">//startfn 的参数</span></span><br><span class="line">	<span class="keyword">void</span>	*udata;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="Task创建"><a href="#Task创建" class="headerlink" title="Task创建"></a>Task创建</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">taskcreate</span><span class="params">(<span class="keyword">void</span> (*fn)(<span class="keyword">void</span>*), <span class="keyword">void</span> *arg, uint <span class="built_in">stack</span>)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> id;</span><br><span class="line">	Task *t;</span><br><span class="line"></span><br><span class="line">	t = taskalloc(fn, arg, <span class="built_in">stack</span>);	<span class="comment">//分配task和stack的空间</span></span><br><span class="line">	taskcount++;	</span><br><span class="line">	id = t-&gt;id;</span><br><span class="line">  <span class="comment">//判断数组是否还有足够空间</span></span><br><span class="line">	<span class="keyword">if</span>(nalltask%<span class="number">64</span> == <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="comment">//扩展数组</span></span><br><span class="line">		alltask = <span class="built_in">realloc</span>(alltask, (nalltask+<span class="number">64</span>)*<span class="keyword">sizeof</span>(alltask[<span class="number">0</span>]));</span><br><span class="line">		<span class="keyword">if</span>(alltask == nil)&#123;</span><br><span class="line">			fprint(<span class="number">2</span>, <span class="string">"out of memory\n"</span>);</span><br><span class="line">			<span class="built_in">abort</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  	<span class="comment">//保存Task在alltask数组内的index</span></span><br><span class="line">	t-&gt;alltaskslot = nalltask;</span><br><span class="line">	alltask[nalltask++] = t;	<span class="comment">//保存task到alltask数组</span></span><br><span class="line">	taskready(t);	<span class="comment">//设置为ready，可以被调度执行</span></span><br><span class="line">	<span class="keyword">return</span> id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//taskalloc分配task和stack的空间</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> Task* <span class="title">taskalloc</span><span class="params">(<span class="keyword">void</span> (*fn)(<span class="keyword">void</span>*), <span class="keyword">void</span> *arg, uint <span class="built_in">stack</span>)</span></span>&#123;</span><br><span class="line">	Task *t;</span><br><span class="line">	<span class="keyword">sigset_t</span> zero;</span><br><span class="line">	uint x, y;</span><br><span class="line">	ulong z;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* allocate the task and stack together */</span></span><br><span class="line">	t = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span> *t+<span class="built_in">stack</span>);	<span class="comment">//分配内存，stack紧跟在task之后</span></span><br><span class="line">	<span class="keyword">if</span>(t == nil)&#123;</span><br><span class="line">		fprint(<span class="number">2</span>, <span class="string">"taskalloc malloc: %r\n"</span>);</span><br><span class="line">		<span class="built_in">abort</span>();</span><br><span class="line">	&#125;</span><br><span class="line">  	<span class="comment">//清除task的内存</span></span><br><span class="line">	<span class="built_in">memset</span>(t, <span class="number">0</span>, <span class="keyword">sizeof</span> *t);</span><br><span class="line">	t-&gt;stk = (uchar*)(t+<span class="number">1</span>);	<span class="comment">//设置stack指针，stack紧跟task之后，t+1指针偏移一个Task大小</span></span><br><span class="line">	t-&gt;stksize = <span class="built_in">stack</span>;	<span class="comment">//设置stack大小</span></span><br><span class="line">	t-&gt;id = ++taskidgen;	<span class="comment">//设置id</span></span><br><span class="line">	t-&gt;startfn = fn;	<span class="comment">//设置任务需要执行的函数</span></span><br><span class="line">	t-&gt;startarg = arg;	<span class="comment">//startfn的参数</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* do a reasonable initialization */</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;t-&gt;context.uc, <span class="number">0</span>, <span class="keyword">sizeof</span> t-&gt;context.uc);</span><br><span class="line">	sigemptyset(&amp;zero);</span><br><span class="line">	sigprocmask(SIG_BLOCK, &amp;zero, &amp;t-&gt;context.uc.uc_sigmask);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* must initialize with current context */</span></span><br><span class="line">	<span class="keyword">if</span>(getcontext(&amp;t-&gt;context.uc) &lt; <span class="number">0</span>)&#123;	<span class="comment">//获取当前ucontext，并保存到t-&gt;context.uc</span></span><br><span class="line">		fprint(<span class="number">2</span>, <span class="string">"getcontext: %r\n"</span>);</span><br><span class="line">		<span class="built_in">abort</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* call makecontext to do the real work. */</span></span><br><span class="line">	<span class="comment">/* leave a few words open on both ends */</span></span><br><span class="line">  	<span class="comment">//设置栈顶指针和栈大小，两端都保留一点空间</span></span><br><span class="line">	t-&gt;context.uc.uc_stack.ss_sp = t-&gt;stk+<span class="number">8</span>;	</span><br><span class="line">	t-&gt;context.uc.uc_stack.ss_size = t-&gt;stksize<span class="number">-64</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__sun__) &amp;&amp; !defined(__MAKECONTEXT_V2_SOURCE)		<span class="comment">/* sigh */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">warning</span> <span class="meta-string">"doing sun thing"</span></span></span><br><span class="line">	<span class="comment">/* can avoid this with __MAKECONTEXT_V2_SOURCE but only on SunOS 5.9 */</span></span><br><span class="line">	t-&gt;context.uc.uc_stack.ss_sp = </span><br><span class="line">		(<span class="keyword">char</span>*)t-&gt;context.uc.uc_stack.ss_sp</span><br><span class="line">		+t-&gt;context.uc.uc_stack.ss_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * All this magic is because you have to pass makecontext a</span></span><br><span class="line"><span class="comment">	 * function that takes some number of word-sized variables,</span></span><br><span class="line"><span class="comment">	 * and on 64-bit machines pointers are bigger than words.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="comment">//print("make %p\n", t);</span></span><br><span class="line">  <span class="comment">//计算startfn的参数:y,x</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  taskstart的参数是uint，即32位，而指针如果是64位，则需要将指针的高32位和低32位分离，分别传递</span></span><br><span class="line"><span class="comment">  将指针分离为高32位(x)和低32位(y)，在taskstart内再通过两个参数合成task指针</span></span><br><span class="line"><span class="comment">  该方法可以同时适用于32位和64位的编译器</span></span><br><span class="line"><span class="comment">  **/</span></span><br><span class="line">	z = (ulong)t;</span><br><span class="line">	y = z;</span><br><span class="line">	z &gt;&gt;= <span class="number">16</span>;	<span class="comment">/* hide undefined 32-bit shift from 32-bit compilers */</span></span><br><span class="line">	x = z&gt;&gt;<span class="number">16</span>;</span><br><span class="line">  <span class="comment">//这里传入的是taskstart函数，在该函数内执调用t-&gt;startfn，并传入t-&gt;startarg</span></span><br><span class="line">	makecontext(&amp;t-&gt;context.uc, (<span class="keyword">void</span>(*)())taskstart, <span class="number">2</span>, y, x);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">初始化uc_context，set the context of coroutine</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> NEEDAMD64MAKECONTEXT</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">makecontext(<span class="keyword">ucontext_t</span> *ucp, <span class="keyword">void</span> (*func)(<span class="keyword">void</span>), <span class="keyword">int</span> argc, ...)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">long</span> *sp;</span><br><span class="line">	va_list va;	<span class="comment">//用于遍历可变长参数的指针</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;ucp-&gt;uc_mcontext, <span class="number">0</span>, <span class="keyword">sizeof</span> ucp-&gt;uc_mcontext);</span><br><span class="line">	<span class="keyword">if</span>(argc != <span class="number">2</span>)</span><br><span class="line">		*(<span class="keyword">int</span>*)<span class="number">0</span> = <span class="number">0</span>;	<span class="comment">//报错</span></span><br><span class="line">	va_start(va, argc);	<span class="comment">//遍历可变参数</span></span><br><span class="line">	<span class="comment">//前6个参数可以使用寄存器（%rdi，%rsi，%rdx，%rcx，%r8，%r9）保存，后面参数入栈</span></span><br><span class="line">	<span class="comment">//用于传递函数参数，rdi：第一个参数，rsi：第二个参数；调用func时传入rdi和rsi</span></span><br><span class="line">	ucp-&gt;uc_mcontext.mc_rdi = va_arg(va, <span class="keyword">int</span>);</span><br><span class="line">	ucp-&gt;uc_mcontext.mc_rsi = va_arg(va, <span class="keyword">int</span>);</span><br><span class="line">	va_end(va);</span><br><span class="line">	<span class="comment">/**设置栈指针**/</span></span><br><span class="line">	sp = (<span class="keyword">long</span>*)ucp-&gt;uc_stack.ss_sp+ucp-&gt;uc_stack.ss_size/<span class="keyword">sizeof</span>(<span class="keyword">long</span>);	<span class="comment">//移动sp指针</span></span><br><span class="line">	sp -= argc;	</span><br><span class="line">	sp = (<span class="keyword">void</span>*)((<span class="keyword">uintptr_t</span>)sp - (<span class="keyword">uintptr_t</span>)sp%<span class="number">16</span>);	<span class="comment">/* 16-align for OS X */</span> <span class="comment">//地址对齐</span></span><br><span class="line">	*--sp = <span class="number">0</span>;	<span class="comment">/* return address */</span></span><br><span class="line">	ucp-&gt;uc_mcontext.mc_rip = (<span class="keyword">long</span>)func;	<span class="comment">//ip，rip存放下一条指令地址</span></span><br><span class="line">	ucp-&gt;uc_mcontext.mc_rsp = (<span class="keyword">long</span>)sp;	<span class="comment">//栈顶指针</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">taskstart(uint y, uint x)</span><br><span class="line">&#123;</span><br><span class="line">	Task *t;</span><br><span class="line">	ulong z;</span><br><span class="line">	<span class="comment">// t = (x&lt;&lt;32)|y</span></span><br><span class="line">	z = x&lt;&lt;<span class="number">16</span>;	<span class="comment">/* hide undefined 32-bit shift from 32-bit compilers */</span></span><br><span class="line">	z &lt;&lt;= <span class="number">16</span>;</span><br><span class="line">	z |= y;</span><br><span class="line">	t = (Task*)z;	<span class="comment">//获取task地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//print("taskstart %p\n", t);</span></span><br><span class="line">	t-&gt;startfn(t-&gt;startarg);	<span class="comment">//调用startfn</span></span><br><span class="line"><span class="comment">//print("taskexits %p\n", t);</span></span><br><span class="line">	taskexit(<span class="number">0</span>);	<span class="comment">//startfn结束，设置退出标志位</span></span><br><span class="line"><span class="comment">//print("not reacehd\n");</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Task调度"><a href="#Task调度" class="headerlink" title="Task调度"></a>Task调度</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Tasklist</span> <span class="title">Tasklist</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Tasklist</span>	/* <span class="title">used</span> <span class="title">internally</span> */</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	Task	*head;</span><br><span class="line">	Task	*tail;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">Context	taskschedcontext;	</span><br><span class="line">Tasklist	taskrunqueue;</span><br><span class="line">Task	*taskrunning;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">needstack(<span class="keyword">int</span> n)</span><br><span class="line">&#123;</span><br><span class="line">	Task *t;</span><br><span class="line"></span><br><span class="line">	t = taskrunning;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>((<span class="keyword">char</span>*)&amp;t &lt;= (<span class="keyword">char</span>*)t-&gt;stk</span><br><span class="line">	|| (<span class="keyword">char</span>*)&amp;t - (<span class="keyword">char</span>*)t-&gt;stk &lt; <span class="number">256</span>+n)&#123;</span><br><span class="line">		fprint(<span class="number">2</span>, <span class="string">"task stack overflow: &amp;t=%p tstk=%p n=%d\n"</span>, &amp;t, t-&gt;stk, <span class="number">256</span>+n);</span><br><span class="line">		<span class="built_in">abort</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">taskswitch(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	needstack(<span class="number">0</span>);</span><br><span class="line">	contextswitch(&amp;taskrunning-&gt;context, &amp;taskschedcontext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">swapcontext(<span class="keyword">ucontext_t</span> *oucp, <span class="keyword">const</span> <span class="keyword">ucontext_t</span> *ucp)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(getcontext(oucp) == <span class="number">0</span>)	<span class="comment">//get the context into *oucp</span></span><br><span class="line">		setcontext(ucp);	<span class="comment">//set the context as *ucp</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">taskready(Task *t)</span><br><span class="line">&#123;</span><br><span class="line">	t-&gt;ready = <span class="number">1</span>;</span><br><span class="line">	addtask(&amp;taskrunqueue, t);	<span class="comment">//加入调度队列</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">taskyield(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> n;</span><br><span class="line">	</span><br><span class="line">	n = tasknswitch;</span><br><span class="line">	taskready(taskrunning);	<span class="comment">//将当前task加入等待队列</span></span><br><span class="line">	taskstate(<span class="string">"yield"</span>);</span><br><span class="line">	taskswitch();	<span class="comment">//切换</span></span><br><span class="line">	<span class="keyword">return</span> tasknswitch - n - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">anyready(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> taskrunqueue.head != nil;	<span class="comment">//判断等待队列队首是否为空</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">taskexit(<span class="keyword">int</span> val)</span><br><span class="line">&#123;</span><br><span class="line">	taskexitval = val;</span><br><span class="line">	taskrunning-&gt;exiting = <span class="number">1</span>;</span><br><span class="line">	taskswitch();	<span class="comment">//切换上下文，执行调度程序</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">taskscheduler(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	Task *t;</span><br><span class="line"></span><br><span class="line">	taskdebug(<span class="string">"scheduler enter"</span>);</span><br><span class="line">	<span class="keyword">for</span>(;;)&#123;</span><br><span class="line">		<span class="keyword">if</span>(taskcount == <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">exit</span>(taskexitval);</span><br><span class="line">		t = taskrunqueue.head;</span><br><span class="line">		<span class="keyword">if</span>(t == nil)&#123;</span><br><span class="line">			fprint(<span class="number">2</span>, <span class="string">"no runnable tasks! %d tasks stalled\n"</span>, taskcount);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		deltask(&amp;taskrunqueue, t);</span><br><span class="line">		t-&gt;ready = <span class="number">0</span>;</span><br><span class="line">		taskrunning = t;	<span class="comment">//设置taskrunning</span></span><br><span class="line">		tasknswitch++;</span><br><span class="line">		taskdebug(<span class="string">"run %d (%s)"</span>, t-&gt;id, t-&gt;name);</span><br><span class="line">      <span class="comment">//当前context保存到taskschedcontext，即taskschedcontext为调度上下文</span></span><br><span class="line">		contextswitch(&amp;taskschedcontext, &amp;t-&gt;context);	<span class="comment">//交换 task context</span></span><br><span class="line"><span class="comment">//print("back in scheduler\n");</span></span><br><span class="line">		taskrunning = nil;</span><br><span class="line">		<span class="keyword">if</span>(t-&gt;exiting)&#123;	<span class="comment">//如果退出</span></span><br><span class="line">			<span class="keyword">if</span>(!t-&gt;system)</span><br><span class="line">				taskcount--;</span><br><span class="line">			i = t-&gt;alltaskslot;</span><br><span class="line">			alltask[i] = alltask[--nalltask];	<span class="comment">//替换为全局数组的最后一个task</span></span><br><span class="line">			alltask[i]-&gt;alltaskslot = i;</span><br><span class="line">			<span class="built_in">free</span>(t);	<span class="comment">//释放task</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * startup</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> taskargc;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> **taskargv;</span><br><span class="line"><span class="keyword">int</span> mainstacksize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">taskmainstart(<span class="keyword">void</span> *v)</span><br><span class="line">&#123;</span><br><span class="line">	taskname(<span class="string">"taskmain"</span>);</span><br><span class="line">	taskmain(taskargc, taskargv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">main(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sa</span>, <span class="title">osa</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;sa, <span class="number">0</span>, <span class="keyword">sizeof</span> sa);</span><br><span class="line">	sa.sa_handler = taskinfo;</span><br><span class="line">	sa.sa_flags = SA_RESTART;</span><br><span class="line">	sigaction(SIGQUIT, &amp;sa, &amp;osa);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SIGINFO</span></span><br><span class="line">	sigaction(SIGINFO, &amp;sa, &amp;osa);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	argv0 = argv[<span class="number">0</span>];</span><br><span class="line">	taskargc = argc;</span><br><span class="line">	taskargv = argv;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(mainstacksize == <span class="number">0</span>)</span><br><span class="line">		mainstacksize = <span class="number">256</span>*<span class="number">1024</span>;</span><br><span class="line">	taskcreate(taskmainstart, nil, mainstacksize);</span><br><span class="line">	taskscheduler();</span><br><span class="line">	fprint(<span class="number">2</span>, <span class="string">"taskscheduler returned in main!\n"</span>);</span><br><span class="line">	<span class="built_in">abort</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
        <div id="comment-container">
        </div>
    </div>
</div>
        </div>
    </div>

    
<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
   <!-- <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p> -->
</footer>




<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":false},"react":{"opacity":0.6}});</script></body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = 
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

</html>